@page "/journal"
@using MoodJournal.Models
@using MoodJournal.Services.Interfaces
@inject IJournalService JournalService
@inject ITagService TagService
@inject IMoodStickerService MoodStickerService
@inject NavigationManager Navigation

<link href="css/JournalView.css" rel="stylesheet" />

<div class="journal-container">
    
    <!-- HEADER -->
    <div class="journal-header">
        <div class="header-left">
            <button class="back-btn" @onclick='() => Navigation.NavigateTo("/main")'>
                ‚Üê Back
            </button>
            <h1 class="page-title">All Journal Entries</h1>
        </div>
        
        <div class="header-right">
            <button class="filter-toggle-btn @(showFilters ? "active" : "")" @onclick="ToggleFilters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                Filters
                @if (HasActiveFilters())
                {
                    <span class="filter-badge">@GetActiveFilterCount()</span>
                }
            </button>
        </div>
    </div>
    
    <!-- FILTER PANEL -->
    @if (showFilters)
    {
        <div class="filter-panel">
            <div class="filter-row">
                
                <!-- DATE RANGE FILTER -->
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" 
                               class="filter-input date-input"
                               value="@filterStartDate"
                               max="@DateTime.Today.ToString("yyyy-MM-dd")"
                               @onchange="OnStartDateChanged" />
                        <span class="date-separator">to</span>
                        <input type="date" 
                               class="filter-input date-input"
                               value="@filterEndDate"
                               max="@DateTime.Today.ToString("yyyy-MM-dd")"
                               @onchange="OnEndDateChanged" />
                    </div>
                </div>
                
                <!-- MOOD FILTER -->
                <div class="filter-group">
                    <label class="filter-label">Mood</label>
                    <select class="filter-input filter-select" @onchange="OnMoodFilterChanged">
                        <option value="">All Moods</option>
                        @foreach (var mood in Moods.All)
                        {
                            <option value="@mood.Key" selected="@(filterMood == mood.Key)">
                                @mood.Value.Emoji @mood.Value.Label
                            </option>
                        }
                    </select>
                </div>
                
                <!-- TAG FILTER -->
                <div class="filter-group">
                    <label class="filter-label">Tag</label>
                    <select class="filter-input filter-select" @onchange="OnTagFilterChanged">
                        <option value="">All Tags</option>
                        @foreach (var tag in availableTags)
                        {
                            <option value="@tag.Name" selected="@(filterTag == tag.Name)">
                                @tag.Name (@tag.UsageCount)
                            </option>
                        }
                    </select>
                </div>
                
                <!-- FILTER ACTIONS -->
                <div class="filter-actions">
                    <button class="apply-btn" @onclick="ApplyFilters">
                        Apply Filters
                    </button>
                    @if (HasActiveFilters())
                    {
                        <button class="clear-btn" @onclick="ClearFilters">
                            Clear All
                        </button>
                    }
                </div>
            </div>
            
            <!-- ACTIVE FILTERS DISPLAY -->
            @if (HasActiveFilters())
            {
                <div class="active-filters">
                    <span class="active-filters-label">Active:</span>
                    @if (!string.IsNullOrEmpty(appliedStartDate) || !string.IsNullOrEmpty(appliedEndDate))
                    {
                        <span class="filter-chip date-chip">
                            üìÖ @GetDateRangeText()
                            <button class="chip-remove" @onclick="ClearDateFilter">√ó</button>
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(appliedMood))
                    {
                        <span class="filter-chip mood-chip">
                            @(Moods.All.ContainsKey(appliedMood) ? Moods.All[appliedMood].Emoji : "") @appliedMood
                            <button class="chip-remove" @onclick="ClearMoodFilter">√ó</button>
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(appliedTag))
                    {
                        <span class="filter-chip tag-chip">
                            üè∑Ô∏è @appliedTag
                            <button class="chip-remove" @onclick="ClearTagFilter">√ó</button>
                        </span>
                    }
                </div>
            }
        </div>
    }
    
    <!-- RESULTS COUNT -->
    @if (!isLoading && filteredEntries.Count > 0)
    {
        <div class="results-info">
            Showing @filteredEntries.Count @(filteredEntries.Count == 1 ? "entry" : "entries")
            @if (HasActiveFilters())
            {
                <span class="filtered-text">(filtered)</span>
            }
        </div>
    }
    
    <!-- ENTRIES LIST -->
    <div class="entries-section">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading entries...</p>
            </div>
        }
        else if (pagedEntries.Count > 0)
        {
            <div class="entries-grid">
                @foreach (var entry in pagedEntries)
                {
                    <div class="entry-card" @onclick="() => EditEntry(entry.EntryDate)">
                        <div class="card-header">
                            <div class="entry-mood-icon">
                                @if (!string.IsNullOrEmpty(entry.PrimaryMood) && entrySvgCache.ContainsKey(entry.Id))
                                {
                                    @((MarkupString)entrySvgCache[entry.Id])
                                }
                            </div>
                            <div class="entry-info">
                                <div class="entry-date-display">@FormatEntryDate(entry.EntryDate)</div>
                                <div class="entry-time-display">@entry.CreatedAt.ToString("h:mm tt")</div>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(entry.Title))
                        {
                            <h3 class="entry-title-display">@entry.Title</h3>
                        }
                        
                        <div class="entry-content-preview">
                            @GetContentPreview(entry.Content)
                        </div>
                        
                        <!-- SHOW TAGS ON CARD -->
                        @if (entryTagsCache.ContainsKey(entry.Id) && entryTagsCache[entry.Id].Count > 0)
                        {
                            <div class="entry-tags-display">
                                @foreach (var tag in entryTagsCache[entry.Id].Take(3))
                                {
                                    <span class="entry-tag">@tag</span>
                                }
                                @if (entryTagsCache[entry.Id].Count > 3)
                                {
                                    <span class="entry-tag more-tags">+@(entryTagsCache[entry.Id].Count - 3)</span>
                                }
                            </div>
                        }
                        
                        <div class="entry-meta-display">
                            <span class="word-count">@GetWordCount(entry.Content) words</span>
                            <span class="mood-label">@entry.PrimaryMood</span>
                        </div>
                    </div>
                }
            </div>
            
            <!-- PAGINATION -->
            <div class="pagination">
                <button class="page-btn" 
                        @onclick="PreviousPage" 
                        disabled="@(currentPage == 1)">
                    ‚Üê Previous
                </button>
                
                <div class="page-info">
                    Page @currentPage of @totalPages
                </div>
                
                <button class="page-btn" 
                        @onclick="NextPage" 
                        disabled="@(currentPage >= totalPages)">
                    Next ‚Üí
                </button>
            </div>
        }
        else
        {
            <div class="empty-state">
                @if (HasActiveFilters())
                {
                    <div class="empty-icon">üîç</div>
                    <div class="empty-text">No entries match your filters</div>
                    <div class="empty-hint">Try adjusting your filter criteria</div>
                    <button class="create-btn" @onclick="ClearFilters">
                        Clear Filters
                    </button>
                }
                else
                {
                    <div class="empty-icon">üìù</div>
                    <div class="empty-text">No journal entries yet</div>
                    <div class="empty-hint">Start writing to see your entries here!</div>
                    <button class="create-btn" @onclick='() => Navigation.NavigateTo("/create-entry")'>
                        Create First Entry
                    </button>
                }
            </div>
        }
    </div>
</div>

@code {
    // Data
    private List<JournalEntry> allEntries = new();
    private List<JournalEntry> filteredEntries = new();
    private List<JournalEntry> pagedEntries = new();
    private Dictionary<int, string> entrySvgCache = new();
    private Dictionary<int, List<string>> entryTagsCache = new();
    private List<Tag> availableTags = new();
    private bool isLoading = true;
    
    // Pagination
    private int currentPage = 1;
    private int entriesPerPage = 10;
    private int totalPages = 1;
    
    // Filter UI state
    private bool showFilters = false;
    private string filterStartDate = "";
    private string filterEndDate = "";
    private string filterMood = "";
    private string filterTag = "";
    
    // Applied filters (used after clicking Apply)
    private string appliedStartDate = "";
    private string appliedEndDate = "";
    private string appliedMood = "";
    private string appliedTag = "";
    
    protected override async Task OnInitializedAsync()
    {
        await LoadTags();
        await LoadEntries();
    }
    
    private async Task LoadTags()
    {
        try
        {
            availableTags = await TagService.GetAllTagsAsync();
            availableTags = availableTags.OrderByDescending(t => t.UsageCount).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
        }
    }
    
    private async Task LoadEntries()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Load all entries
            allEntries = await JournalService.GetAllEntriesAsync();
            
            // Sort by date descending (newest first)
            allEntries = allEntries
                .OrderByDescending(e => DateTime.Parse(e.EntryDate))
                .ThenByDescending(e => e.CreatedAt)
                .ToList();
            
            // Load tags for all entries
            await LoadTagsForEntries();
            
            // Apply filters
            ApplyFiltersInternal();
            
            Console.WriteLine($"Loaded {allEntries.Count} entries, {totalPages} pages");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entries: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadTagsForEntries()
    {
        entryTagsCache.Clear();
        
        foreach (var entry in allEntries)
        {
            try
            {
                var tags = await JournalService.GetTagsForEntryAsync(entry.Id);
                entryTagsCache[entry.Id] = tags.Select(t => t.Name).ToList();
            }
            catch
            {
                entryTagsCache[entry.Id] = new List<string>();
            }
        }
    }
    
    private void ApplyFiltersInternal()
    {
        // Start with all entries
        filteredEntries = allEntries.ToList();
        
        // Filter by date range
        if (!string.IsNullOrEmpty(appliedStartDate))
        {
            filteredEntries = filteredEntries
                .Where(e => string.Compare(e.EntryDate, appliedStartDate) >= 0)
                .ToList();
        }
        
        if (!string.IsNullOrEmpty(appliedEndDate))
        {
            filteredEntries = filteredEntries
                .Where(e => string.Compare(e.EntryDate, appliedEndDate) <= 0)
                .ToList();
        }
        
        // Filter by mood (check primary or secondary moods)
        if (!string.IsNullOrEmpty(appliedMood))
        {
            filteredEntries = filteredEntries
                .Where(e => e.PrimaryMood == appliedMood || 
                           (e.SecondaryMoods != null && e.SecondaryMoods.Contains(appliedMood)))
                .ToList();
        }
        
        // Filter by tag
        if (!string.IsNullOrEmpty(appliedTag))
        {
            filteredEntries = filteredEntries
                .Where(e => entryTagsCache.ContainsKey(e.Id) && 
                           entryTagsCache[e.Id].Contains(appliedTag))
                .ToList();
        }
        
        // Calculate pagination based on filtered results
        totalPages = (int)Math.Ceiling((double)filteredEntries.Count / entriesPerPage);
        if (totalPages == 0) totalPages = 1;
        
        // Reset to first page when filters change
        LoadPage(1);
    }
    
    private async Task LoadPage(int page)
    {
        currentPage = Math.Max(1, Math.Min(page, totalPages));
        
        var skip = (currentPage - 1) * entriesPerPage;
        pagedEntries = filteredEntries
            .Skip(skip)
            .Take(entriesPerPage)
            .ToList();
        
        // Load mood stickers for paged entries
        await LoadMoodStickersForEntries();
        
        Console.WriteLine($"Loaded page {currentPage}/{totalPages} ({pagedEntries.Count} entries)");
    }
    
    private async Task LoadMoodStickersForEntries()
    {
        entrySvgCache.Clear();
        
        foreach (var entry in pagedEntries)
        {
            if (!string.IsNullOrEmpty(entry.PrimaryMood))
            {
                try
                {
                    var svg = await MoodStickerService.GenerateMoodStickerSvgAsync(
                        entry.PrimaryMood, 80, 80
                    );
                    entrySvgCache[entry.Id] = svg;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error generating sticker for entry {entry.Id}: {ex.Message}");
                }
            }
        }
    }
    
    // Filter UI handlers
    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }
    
    private void OnStartDateChanged(ChangeEventArgs e)
    {
        filterStartDate = e.Value?.ToString() ?? "";
    }
    
    private void OnEndDateChanged(ChangeEventArgs e)
    {
        filterEndDate = e.Value?.ToString() ?? "";
    }
    
    private void OnMoodFilterChanged(ChangeEventArgs e)
    {
        filterMood = e.Value?.ToString() ?? "";
    }
    
    private void OnTagFilterChanged(ChangeEventArgs e)
    {
        filterTag = e.Value?.ToString() ?? "";
    }
    
    private async Task ApplyFilters()
    {
        appliedStartDate = filterStartDate;
        appliedEndDate = filterEndDate;
        appliedMood = filterMood;
        appliedTag = filterTag;
        
        ApplyFiltersInternal();
        await LoadMoodStickersForEntries();
        StateHasChanged();
    }
    
    private async Task ClearFilters()
    {
        filterStartDate = "";
        filterEndDate = "";
        filterMood = "";
        filterTag = "";
        appliedStartDate = "";
        appliedEndDate = "";
        appliedMood = "";
        appliedTag = "";
        
        ApplyFiltersInternal();
        await LoadMoodStickersForEntries();
        StateHasChanged();
    }
    
    private async Task ClearDateFilter()
    {
        filterStartDate = "";
        filterEndDate = "";
        appliedStartDate = "";
        appliedEndDate = "";
        await ApplyFilters();
    }
    
    private async Task ClearMoodFilter()
    {
        filterMood = "";
        appliedMood = "";
        await ApplyFilters();
    }
    
    private async Task ClearTagFilter()
    {
        filterTag = "";
        appliedTag = "";
        await ApplyFilters();
    }
    
    private bool HasActiveFilters()
    {
        return !string.IsNullOrEmpty(appliedStartDate) ||
               !string.IsNullOrEmpty(appliedEndDate) ||
               !string.IsNullOrEmpty(appliedMood) ||
               !string.IsNullOrEmpty(appliedTag);
    }
    
    private int GetActiveFilterCount()
    {
        int count = 0;
        if (!string.IsNullOrEmpty(appliedStartDate) || !string.IsNullOrEmpty(appliedEndDate)) count++;
        if (!string.IsNullOrEmpty(appliedMood)) count++;
        if (!string.IsNullOrEmpty(appliedTag)) count++;
        return count;
    }
    
    private string GetDateRangeText()
    {
        if (!string.IsNullOrEmpty(appliedStartDate) && !string.IsNullOrEmpty(appliedEndDate))
        {
            return $"{FormatShortDate(appliedStartDate)} - {FormatShortDate(appliedEndDate)}";
        }
        else if (!string.IsNullOrEmpty(appliedStartDate))
        {
            return $"From {FormatShortDate(appliedStartDate)}";
        }
        else if (!string.IsNullOrEmpty(appliedEndDate))
        {
            return $"Until {FormatShortDate(appliedEndDate)}";
        }
        return "";
    }
    
    private string FormatShortDate(string dateString)
    {
        if (DateTime.TryParse(dateString, out var date))
        {
            return date.ToString("MMM dd");
        }
        return dateString;
    }
    
    // Pagination
    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            await LoadPage(currentPage - 1);
            StateHasChanged();
        }
    }
    
    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            await LoadPage(currentPage + 1);
            StateHasChanged();
        }
    }
    
    private void EditEntry(string date)
    {
        Navigation.NavigateTo($"/create-entry/{date}");
    }
    
    private string FormatEntryDate(string dateString)
    {
        if (DateTime.TryParse(dateString, out var date))
        {
            var today = DateTime.Today;
            var yesterday = today.AddDays(-1);
            
            if (date.Date == today)
                return "Today";
            else if (date.Date == yesterday)
                return "Yesterday";
            else if (date.Year == today.Year)
                return date.ToString("MMMM dd");
            else
                return date.ToString("MMM dd, yyyy");
        }
        return dateString;
    }
    
    private string GetContentPreview(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "No content";
        
        // Strip HTML tags
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        
        // Truncate
        if (plainText.Length > 150)
            return plainText.Substring(0, 150) + "...";
        
        return plainText;
    }
    
    private int GetWordCount(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return 0;
        
        // Strip HTML tags
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        
        // Count words
        return plainText.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }
}
