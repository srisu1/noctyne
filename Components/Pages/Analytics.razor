@page "/analytics"
@using MoodJournal.Models
@using MoodJournal.Services.Interfaces
@inject IJournalService JournalService
@inject ITagService TagService
@inject IMoodStickerService MoodStickerService
@inject NavigationManager Navigation

<div class="analytics-container">
    
    <!-- HEADER -->
    <div class="analytics-header">
        <button class="back-btn" @onclick='() => Navigation.NavigateTo("/main")'>
            ‚Üê Back to Main
        </button>
        <h1 class="page-title">Analytics & Insights</h1>
    </div>
    
    <!-- TIME PERIOD FILTERS -->
    <div class="time-filters">
        <button class="filter-btn @(timePeriod == "week" ? "active" : "")" @onclick='() => SetTimePeriod("week")'>
            Last Week
        </button>
        <button class="filter-btn @(timePeriod == "month" ? "active" : "")" @onclick='() => SetTimePeriod("month")'>
            Last Month
        </button>
        <button class="filter-btn @(timePeriod == "year" ? "active" : "")" @onclick='() => SetTimePeriod("year")'>
            Last Year
        </button>
        <button class="filter-btn @(timePeriod == "all" ? "active" : "")" @onclick='() => SetTimePeriod("all")'>
            All Time
        </button>
    </div>
    
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading analytics...</p>
        </div>
    }
    else
    {
        <!-- MOOD DISTRIBUTION -->
        <div class="analytics-card">
            <h2 class="card-title">Mood Distribution</h2>
            <div class="mood-distribution">
                @foreach (var mood in moodStats.OrderByDescending(m => m.Value))
                {
                    var percentage = totalEntries > 0 ? (mood.Value * 100.0 / totalEntries) : 0;
                    <div class="mood-bar-item">
                        <div class="mood-bar-header">
                            <div class="mood-info">
                                @if (moodStickers.ContainsKey(mood.Key))
                                {
                                    <div class="mood-sticker-icon">
                                        @((MarkupString)moodStickers[mood.Key])
                                    </div>
                                }
                                <span class="mood-name">@mood.Key</span>
                            </div>
                            <span class="mood-count">@mood.Value entries (@percentage.ToString("F1")%)</span>
                        </div>
                        <div class="mood-bar-track">
                            <div class="mood-bar-fill @(IsPositiveMood(mood.Key) ? "positive" : "negative")" style="width: @percentage%"></div>
                        </div>
                    </div>
                }
            </div>
        </div>
        
        <!-- MOOD TRENDS - DUAL LINE GRAPH -->
        <div class="analytics-card">
            <h2 class="card-title">Mood Trends Over Time</h2>
            
            <!-- LEGEND -->
            <div class="trend-legend">
                <div class="legend-item">
                    <div class="legend-line positive"></div>
                    <span>Positive Moods</span>
                    <span class="legend-moods">(happy, excited, calm, grateful)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line negative"></div>
                    <span>Negative Moods</span>
                    <span class="legend-moods">(sad, anxious, angry, tired)</span>
                </div>
            </div>
            
            <div class="mood-trends">
                @if (dualTrendData.Any())
                {
                    <div class="dual-trend-chart">
                        <!-- Y-AXIS LABELS -->
                        <div class="y-axis">
                            <span class="y-label">High</span>
                            <span class="y-label">Mid</span>
                            <span class="y-label">Low</span>
                        </div>
                        
                        <!-- CHART AREA -->
                        <div class="chart-area">
                            <!-- GRID LINES -->
                            <div class="grid-lines">
                                <div class="grid-line"></div>
                                <div class="grid-line"></div>
                                <div class="grid-line"></div>
                            </div>
                            
                            <!-- SVG LINES -->
                            <svg class="trend-svg" viewBox="0 0 1000 400" preserveAspectRatio="none">
                                @{
                                    var maxCount = Math.Max(
                                        dualTrendData.Max(p => p.PositiveCount),
                                        dualTrendData.Max(p => p.NegativeCount)
                                    );
                                    if (maxCount == 0) maxCount = 1;
                                    
                                    var positivePoints = new List<string>();
                                    var negativePoints = new List<string>();
                                    var pointSpacing = dualTrendData.Count > 1 ? 1000.0 / (dualTrendData.Count - 1) : 500;
                                    
                                    for (int i = 0; i < dualTrendData.Count; i++)
                                    {
                                        var point = dualTrendData[i];
                                        var x = dualTrendData.Count > 1 ? i * pointSpacing : 500;
                                        
                                        var positiveY = 380 - (point.PositiveCount * 340.0 / maxCount);
                                        var negativeY = 380 - (point.NegativeCount * 340.0 / maxCount);
                                        
                                        positivePoints.Add($"{x:F0},{positiveY:F0}");
                                        negativePoints.Add($"{x:F0},{negativeY:F0}");
                                    }
                                    
                                    var positivePath = positivePoints.Count > 1 
                                        ? "M " + string.Join(" L ", positivePoints)
                                        : "";
                                    var negativePath = negativePoints.Count > 1 
                                        ? "M " + string.Join(" L ", negativePoints)
                                        : "";
                                }
                                
                                <!-- Positive line (green) -->
                                @if (!string.IsNullOrEmpty(positivePath))
                                {
                                    <path class="trend-path positive-path" d="@positivePath" />
                                }
                                
                                <!-- Negative line (pink) -->
                                @if (!string.IsNullOrEmpty(negativePath))
                                {
                                    <path class="trend-path negative-path" d="@negativePath" />
                                }
                            </svg>
                            
                            <!-- DATA POINTS WITH STICKERS -->
                            <div class="data-points-container">
                                @{
                                    var chartMaxCount = Math.Max(
                                        dualTrendData.Max(p => p.PositiveCount),
                                        dualTrendData.Max(p => p.NegativeCount)
                                    );
                                    if (chartMaxCount == 0) chartMaxCount = 1;
                                }
                                
                                @foreach (var point in dualTrendData)
                                {
                                    var positivePercent = point.PositiveCount * 100.0 / chartMaxCount;
                                    var negativePercent = point.NegativeCount * 100.0 / chartMaxCount;
                                    
                                    <div class="data-point-column">
                                        <!-- Positive point -->
                                        @if (point.PositiveCount > 0)
                                        {
                                            <div class="data-point positive-point" 
                                                 style="bottom: @(positivePercent * 0.85)%"
                                                 title="@point.Label: @point.PositiveCount positive">
                                                @if (!string.IsNullOrEmpty(point.PositiveMoodSticker))
                                                {
                                                    <div class="point-sticker">
                                                        @((MarkupString)point.PositiveMoodSticker)
                                                    </div>
                                                }
                                                <div class="point-dot positive"></div>
                                            </div>
                                        }
                                        
                                        <!-- Negative point -->
                                        @if (point.NegativeCount > 0)
                                        {
                                            <div class="data-point negative-point" 
                                                 style="bottom: @(negativePercent * 0.85)%"
                                                 title="@point.Label: @point.NegativeCount negative">
                                                @if (!string.IsNullOrEmpty(point.NegativeMoodSticker))
                                                {
                                                    <div class="point-sticker">
                                                        @((MarkupString)point.NegativeMoodSticker)
                                                    </div>
                                                }
                                                <div class="point-dot negative"></div>
                                            </div>
                                        }
                                        
                                        <!-- X-axis label -->
                                        <div class="x-label">@point.Label</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- MOOD BALANCE SUMMARY -->
                    <div class="mood-balance">
                        <div class="balance-item positive">
                            <span class="balance-icon">üòä</span>
                            <span class="balance-value">@totalPositiveMoods</span>
                            <span class="balance-label">Positive Days</span>
                        </div>
                        <div class="balance-meter">
                            <div class="balance-bar">
                                <div class="balance-fill positive" style="width: @GetPositivePercentage()%"></div>
                                <div class="balance-fill negative" style="width: @GetNegativePercentage()%"></div>
                            </div>
                            <div class="balance-ratio">@GetPositivePercentage().ToString("F0")% / @GetNegativePercentage().ToString("F0")%</div>
                        </div>
                        <div class="balance-item negative">
                            <span class="balance-icon">üòî</span>
                            <span class="balance-value">@totalNegativeMoods</span>
                            <span class="balance-label">Challenging Days</span>
                        </div>
                    </div>
                }
                else
                {
                    <div class="empty-chart">No mood data available for this period</div>
                }
            </div>
        </div>
        
        <div class="analytics-grid">
            
            <!-- MOST USED TAGS -->
            <div class="analytics-card">
                <h2 class="card-title">Most Used Tags</h2>
                <div class="tags-chart">
                    @if (topTags.Any())
                    {
                        var maxUsage = topTags.Max(t => t.UsageCount);
                        var tagColors = new[] { "#a8d5a3", "#f490af", "#ffd93d", "#95d1cc", "#ff9f45", "#7ba3d4" };
                        var colorIndex = 0;
                        
                        @foreach (var tag in topTags)
                        {
                            var widthPercent = maxUsage > 0 ? (tag.UsageCount * 100.0 / maxUsage) : 0;
                            var tagColor = tagColors[colorIndex % tagColors.Length];
                            colorIndex++;
                            
                            <div class="tag-bar-item">
                                <div class="tag-bar-header">
                                    <span class="tag-name">üè∑Ô∏è @tag.Name</span>
                                    <span class="tag-count">@tag.UsageCount</span>
                                </div>
                                <div class="tag-bar-track">
                                    <div class="tag-bar-fill" style="width: @widthPercent%; background: @tagColor"></div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-chart">No tags used yet</div>
                    }
                </div>
            </div>
            
            <!-- WORD COUNT TRENDS -->
            <div class="analytics-card">
                <h2 class="card-title">Word Count Trends</h2>
                <div class="word-stats">
                    <div class="stat-box">
                        <div class="stat-value-big">@avgWordCount</div>
                        <div class="stat-label-big">Avg Words/Entry</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value-big">@totalWords</div>
                        <div class="stat-label-big">Total Words</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value-big">@totalEntries</div>
                        <div class="stat-label-big">Total Entries</div>
                    </div>
                </div>
                
                @if (wordCountTrend.Any())
                {
                    <div class="word-trend-chart">
                        @{
                            var maxWords = wordCountTrend.Max(w => w.WordCount);
                            if (maxWords == 0) maxWords = 1;
                        }
                        @foreach (var point in wordCountTrend)
                        {
                            var heightPercent = point.WordCount * 100.0 / maxWords;
                            
                            <div class="word-bar" style="height: @heightPercent%" title="@point.Date: @point.WordCount words">
                                <span class="word-bar-label">@point.Date</span>
                            </div>
                        }
                    </div>
                }
            </div>
            
        </div>
        
        <!-- STREAK INFO -->
        <div class="analytics-card">
            <h2 class="card-title">Journaling Streaks</h2>
            <div class="streak-stats">
                <div class="streak-box">
                    <div class="streak-icon">üî•</div>
                    <div class="streak-value">@currentStreak</div>
                    <div class="streak-label">Current Streak</div>
                </div>
                <div class="streak-box">
                    <div class="streak-icon">üèÜ</div>
                    <div class="streak-value">@longestStreak</div>
                    <div class="streak-label">Longest Streak</div>
                </div>
                <div class="streak-box">
                    <div class="streak-icon">üìù</div>
                    <div class="streak-value">@totalEntries</div>
                    <div class="streak-label">Total Entries</div>
                </div>
                <div class="streak-box">
                    <div class="streak-icon">‚ùå</div>
                    <div class="streak-value">@missedDays</div>
                    <div class="streak-label">Missed Days</div>
                </div>
            </div>
        </div>
    }
    
</div>

@code {
    // Dual trend data point
    private class DualTrendPoint
    {
        public string Label { get; set; } = "";
        public int PositiveCount { get; set; }
        public int NegativeCount { get; set; }
        public string PositiveMoodSticker { get; set; } = "";
        public string NegativeMoodSticker { get; set; } = "";
        public string DominantPositiveMood { get; set; } = "";
        public string DominantNegativeMood { get; set; } = "";
    }
    
    private class WordTrendPoint
    {
        public string Date { get; set; } = "";
        public int WordCount { get; set; }
    }
    
    // Mood categories
    private static readonly HashSet<string> PositiveMoods = new() { "happy", "excited", "calm", "grateful" };
    private static readonly HashSet<string> NegativeMoods = new() { "sad", "anxious", "angry", "tired" };
    
    private bool isLoading = true;
    private string timePeriod = "month";
    
    private Dictionary<string, int> moodStats = new();
    private Dictionary<string, string> moodStickers = new();
    private List<DualTrendPoint> dualTrendData = new();
    private List<Tag> topTags = new();
    private List<WordTrendPoint> wordCountTrend = new();
    
    private int totalEntries = 0;
    private int totalWords = 0;
    private int avgWordCount = 0;
    private int currentStreak = 0;
    private int longestStreak = 0;
    private int missedDays = 0;
    private int totalPositiveMoods = 0;
    private int totalNegativeMoods = 0;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadAnalytics();
    }
    
    private bool IsPositiveMood(string mood) => PositiveMoods.Contains(mood.ToLower());
    private bool IsNegativeMood(string mood) => NegativeMoods.Contains(mood.ToLower());
    
    private double GetPositivePercentage()
    {
        var total = totalPositiveMoods + totalNegativeMoods;
        return total > 0 ? (totalPositiveMoods * 100.0 / total) : 50;
    }
    
    private double GetNegativePercentage()
    {
        var total = totalPositiveMoods + totalNegativeMoods;
        return total > 0 ? (totalNegativeMoods * 100.0 / total) : 50;
    }
    
    private async Task SetTimePeriod(string period)
    {
        timePeriod = period;
        await LoadAnalytics();
    }
    
    private async Task LoadAnalytics()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            var endDate = DateTime.Now.ToString("yyyy-MM-dd");
            var startDate = timePeriod switch
            {
                "week" => DateTime.Now.AddDays(-7).ToString("yyyy-MM-dd"),
                "month" => DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd"),
                "year" => DateTime.Now.AddYears(-1).ToString("yyyy-MM-dd"),
                _ => "2000-01-01"
            };
            
            var entries = await JournalService.GetEntriesByDateRangeAsync(startDate, endDate);
            totalEntries = entries.Count;
            
            // Reset counters
            totalPositiveMoods = 0;
            totalNegativeMoods = 0;
            
            if (totalEntries > 0)
            {
                // Mood distribution stats
                moodStats = entries.GroupBy(e => e.PrimaryMood).ToDictionary(g => g.Key, g => g.Count());
                
                // Count positive vs negative
                foreach (var entry in entries)
                {
                    if (IsPositiveMood(entry.PrimaryMood))
                        totalPositiveMoods++;
                    else if (IsNegativeMood(entry.PrimaryMood))
                        totalNegativeMoods++;
                }
                
                // Load mood stickers
                foreach (var mood in moodStats.Keys)
                {
                    try
                    {
                        var svg = await MoodStickerService.GenerateMoodStickerSvgAsync(mood, 40, 40);
                        moodStickers[mood] = svg;
                    }
                    catch { }
                }
                
                // Build dual trend data
                var trendGroups = timePeriod == "week" || timePeriod == "month"
                    ? entries.GroupBy(e => DateTime.Parse(e.EntryDate).ToString("MMM dd"))
                        .OrderBy(g => DateTime.Parse(g.First().EntryDate))
                        .Take(14)
                        .ToList()
                    : entries.GroupBy(e => DateTime.Parse(e.EntryDate).ToString("MMM yyyy"))
                        .OrderBy(g => DateTime.Parse(g.First().EntryDate))
                        .Take(12)
                        .ToList();
                
                dualTrendData = new List<DualTrendPoint>();
                
                foreach (var group in trendGroups)
                {
                    var positiveEntries = group.Where(e => IsPositiveMood(e.PrimaryMood)).ToList();
                    var negativeEntries = group.Where(e => IsNegativeMood(e.PrimaryMood)).ToList();
                    
                    var point = new DualTrendPoint
                    {
                        Label = group.Key,
                        PositiveCount = positiveEntries.Count,
                        NegativeCount = negativeEntries.Count
                    };
                    
                    // Get dominant positive mood sticker
                    if (positiveEntries.Any())
                    {
                        var dominantPositive = positiveEntries
                            .GroupBy(e => e.PrimaryMood)
                            .OrderByDescending(g => g.Count())
                            .First().Key;
                        point.DominantPositiveMood = dominantPositive;
                        try
                        {
                            point.PositiveMoodSticker = await MoodStickerService.GenerateMoodStickerSvgAsync(dominantPositive, 45, 45);
                        }
                        catch { }
                    }
                    
                    // Get dominant negative mood sticker
                    if (negativeEntries.Any())
                    {
                        var dominantNegative = negativeEntries
                            .GroupBy(e => e.PrimaryMood)
                            .OrderByDescending(g => g.Count())
                            .First().Key;
                        point.DominantNegativeMood = dominantNegative;
                        try
                        {
                            point.NegativeMoodSticker = await MoodStickerService.GenerateMoodStickerSvgAsync(dominantNegative, 45, 45);
                        }
                        catch { }
                    }
                    
                    dualTrendData.Add(point);
                }
                
                // Word count stats
                totalWords = entries.Sum(e => e.WordCount);
                avgWordCount = totalEntries > 0 ? totalWords / totalEntries : 0;
                
                wordCountTrend = entries
                    .OrderBy(e => e.EntryDate)
                    .Take(20)
                    .Select(e => new WordTrendPoint 
                    { 
                        Date = DateTime.Parse(e.EntryDate).ToString("MMM dd"), 
                        WordCount = e.WordCount 
                    })
                    .ToList();
            }
            
            // Load tags
            topTags = await TagService.GetMostUsedTagsAsync(10);
            
            // Calculate streaks
            try
            {
                var allEntries = await JournalService.GetAllEntriesAsync();
                if (allEntries.Any())
                {
                    var sortedDates = allEntries
                        .Select(e => DateTime.Parse(e.EntryDate))
                        .OrderByDescending(d => d)
                        .ToList();
                    
                    currentStreak = 0;
                    var checkDate = DateTime.Today;
                    
                    if (sortedDates.Contains(checkDate))
                    {
                        currentStreak = 1;
                        for (int i = 1; i <= sortedDates.Count; i++)
                        {
                            if (sortedDates.Contains(checkDate.AddDays(-i)))
                                currentStreak++;
                            else
                                break;
                        }
                    }
                    else if (sortedDates.Contains(checkDate.AddDays(-1)))
                    {
                        currentStreak = 1;
                        checkDate = checkDate.AddDays(-1);
                        for (int i = 1; i <= sortedDates.Count; i++)
                        {
                            if (sortedDates.Contains(checkDate.AddDays(-i)))
                                currentStreak++;
                            else
                                break;
                        }
                    }
                    
                    // Calculate longest streak
                    longestStreak = Math.Max(1, currentStreak);
                    var tempStreak = 1;
                    for (int i = 0; i < sortedDates.Count - 1; i++)
                    {
                        if ((sortedDates[i] - sortedDates[i + 1]).Days == 1)
                        {
                            tempStreak++;
                            longestStreak = Math.Max(longestStreak, tempStreak);
                        }
                        else
                        {
                            tempStreak = 1;
                        }
                    }
                    
                    // Calculate missed days
                    var firstEntry = sortedDates.Min();
                    var daysSinceFirst = (DateTime.Today - firstEntry).Days + 1;
                    missedDays = Math.Max(0, daysSinceFirst - allEntries.Count);
                }
            }
            catch { }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Analytics Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
