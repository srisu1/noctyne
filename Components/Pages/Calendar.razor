@page "/calendar"
@using MoodJournal.Models
@using MoodJournal.Services.Interfaces
@using Microsoft.JSInterop
@inject IJournalService JournalService
@inject IMoodStickerService MoodStickerService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="calendar-container">
    
    <!-- MONTH NAVIGATION -->
    <div class="calendar-top-header">
        <div class="calendar-title-section">
            <button class="back-btn" @onclick='() => Navigation.NavigateTo("/main")'>
                ‚Üê Back to Main
            </button>
            <h1 class="page-title">Journal Calendar</h1>
        </div>
        
        <div class="calendar-nav-section">
            <div class="month-navigation">
                <button class="nav-btn" @onclick="PreviousMonth">‚Üê Previous</button>
                <h2 class="current-month">@GetMonthYearDisplay()</h2>
                <button class="nav-btn" @onclick="NextMonth">Next ‚Üí</button>
            </div>
            <button class="today-btn" @onclick="JumpToToday">Today</button>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="calendar-content">
        
        <!-- CALENDAR GRID -->
        <div class="calendar-section">
            <div class="calendar-grid-container">
                
                <!-- Weekday Headers -->
                <div class="weekday-headers">
                    <div class="weekday">Sun</div>
                    <div class="weekday">Mon</div>
                    <div class="weekday">Tue</div>
                    <div class="weekday">Wed</div>
                    <div class="weekday">Thu</div>
                    <div class="weekday">Fri</div>
                    <div class="weekday">Sat</div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    @foreach (var date in calendarDates)
                    {
                        var cssClass = GetDateCssClass(date);
                        var hasEntry = entriesByDate.ContainsKey(date.DateString);
                        
                        <div class="calendar-date @cssClass" @onclick="() => SelectDate(date)">
                            <span class="date-number">@date.Day</span>
                            
                            @if (hasEntry && moodStickers.ContainsKey(date.DateString))
                            {
                                <div class="date-indicator">
                                    <div class="mood-sticker-small">
                                        @((MarkupString)moodStickers[date.DateString])
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

            </div>
        </div>

        <!-- PREVIEW PANEL -->
        <div class="preview-section">
            
            @if (selectedEntry != null && selectedDate != null)
            {
                <!-- Entry Preview -->
                <div class="preview-card">
                    <div class="preview-date">@FormatDateLong(selectedDate.Value)</div>

                    <div class="preview-mood">
                        @if (selectedMoodSticker != null)
                        {
                            <div class="preview-mood-sticker">
                                @((MarkupString)selectedMoodSticker)
                            </div>
                        }
                        <span class="preview-mood-text">@GetMoodDisplayText(selectedEntry)</span>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedEntry.Title))
                    {
                        <h3 class="preview-title">@selectedEntry.Title</h3>
                    }

                    <div class="preview-content">
                        @((MarkupString)selectedEntry.Content)
                    </div>

                    @if (selectedTags.Count > 0)
                    {
                        <div class="preview-tags">
                            @foreach (var tag in selectedTags)
                            {
                                <span class="preview-tag">@tag.Name</span>
                            }
                        </div>
                    }

                    <div class="preview-meta">
                        <div class="meta-item">Created: @selectedEntry.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</div>
                        <div class="meta-item">Word Count: @GetWordCount(selectedEntry.Content)</div>
                    </div>

                    <div class="preview-actions">
                        <button class="action-btn btn-edit" @onclick="EditEntry">Edit Entry</button>
                        <button class="action-btn btn-delete" @onclick="DeleteEntry">Delete</button>
                    </div>
                </div>
            }
            else if (selectedDate != null)
            {
                <!-- No Entry State -->
                <div class="preview-card empty-preview">
                    <div class="empty-preview-icon">üìù</div>
                    <div class="empty-preview-text">No entry for this day</div>
                    <div class="empty-preview-hint">Click a date with an entry to view it</div>
                </div>
            }
            else
            {
                <!-- Default State -->
                <div class="preview-card empty-preview">
                    <div class="empty-preview-icon">üóìÔ∏è</div>
                    <div class="empty-preview-text">Select a date</div>
                    <div class="empty-preview-hint">Click on any date to view or create an entry</div>
                </div>
            }

            <!-- Legend -->
            <div class="legend-card">
                <h3 class="legend-title">Legend</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-indicator" style="background: #a8d5a3; border: 4px solid #3d3d3d;"></div>
                        <span>Today</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator" style="background: white; border: 4px solid #3d3d3d;"></div>
                        <span>Has Entry</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator" style="background: #e8f4ff; border: 4px solid #a8d5a3;"></div>
                        <span>Selected</span>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

@code {
    private class CalendarDate
    {
        public DateTime Date { get; set; }
        public int Day { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
        public bool IsSelected { get; set; }
        public string DateString { get; set; } = string.Empty;
    }

    private int currentYear = DateTime.Now.Year;
    private int currentMonth = DateTime.Now.Month;
    private List<CalendarDate> calendarDates = new();
    private Dictionary<string, JournalEntry> entriesByDate = new();
    private Dictionary<string, string> moodStickers = new();
    
    private DateTime? selectedDate = null;
    private JournalEntry? selectedEntry = null;
    private string? selectedMoodSticker = null;
    private List<Tag> selectedTags = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthEntries();
    }

    private async Task LoadMonthEntries()
    {
        try
        {
            GenerateCalendarDates();
            
            var startDate = new DateTime(currentYear, currentMonth, 1).ToString("yyyy-MM-dd");
            var endDate = new DateTime(currentYear, currentMonth, DateTime.DaysInMonth(currentYear, currentMonth)).ToString("yyyy-MM-dd");
            
            var entries = await JournalService.GetEntriesByDateRangeAsync(startDate, endDate);
            
            entriesByDate.Clear();
            foreach (var entry in entries)
            {
                entriesByDate[entry.EntryDate] = entry;
            }
            
            await LoadMoodStickersForEntries();
            
            Console.WriteLine($"Loaded {entries.Count} entries for {currentMonth}/{currentYear}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading month entries: {ex.Message}");
        }
    }

    private async Task LoadMoodStickersForEntries()
    {
        moodStickers.Clear();
        
        foreach (var kvp in entriesByDate)
        {
            if (!string.IsNullOrEmpty(kvp.Value.PrimaryMood))
            {
                try
                {
                    var svg = await MoodStickerService.GenerateMoodStickerSvgAsync(
                        kvp.Value.PrimaryMood, 70, 70
                    );
                    moodStickers[kvp.Key] = svg;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error generating sticker: {ex.Message}");
                }
            }
        }
    }

    private void GenerateCalendarDates()
    {
        calendarDates.Clear();
        
        var firstDay = new DateTime(currentYear, currentMonth, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);
        
        var startDate = firstDay.AddDays(-(int)firstDay.DayOfWeek);
        var endDate = lastDay.AddDays(6 - (int)lastDay.DayOfWeek);
        
        var current = startDate;
        while (current <= endDate)
        {
            calendarDates.Add(new CalendarDate
            {
                Date = current,
                Day = current.Day,
                IsCurrentMonth = current.Month == currentMonth,
                IsToday = current.Date == DateTime.Today,
                IsSelected = selectedDate.HasValue && current.Date == selectedDate.Value.Date,
                DateString = current.ToString("yyyy-MM-dd")
            });
            
            current = current.AddDays(1);
        }
    }

    private async Task SelectDate(CalendarDate date)
    {
        selectedDate = date.Date;
        
        if (entriesByDate.ContainsKey(date.DateString))
        {
            selectedEntry = entriesByDate[date.DateString];
            
            if (!string.IsNullOrEmpty(selectedEntry.PrimaryMood))
            {
                selectedMoodSticker = await MoodStickerService.GenerateMoodStickerSvgAsync(
                    selectedEntry.PrimaryMood, 100, 100
                );
            }
            
            
            selectedTags = await JournalService.GetTagsForEntryAsync(selectedEntry.Id);
        }
        else
        {
            selectedEntry = null;
            selectedMoodSticker = null;
            selectedTags.Clear();
        }
        
        GenerateCalendarDates();
        StateHasChanged();
    }

    private string GetDateCssClass(CalendarDate date)
    {
        var classes = new List<string>();
        
        if (!date.IsCurrentMonth)
            classes.Add("other-month");
        
        if (date.IsToday)
            classes.Add("today");
        
        if (entriesByDate.ContainsKey(date.DateString))
            classes.Add("has-entry");
        
        if (date.IsSelected)
            classes.Add("selected");
        
        return string.Join(" ", classes);
    }

    private string GetMoodDisplayText(JournalEntry entry)
    {
        var moods = new List<string>();
        
        // Primary mood
        if (!string.IsNullOrEmpty(entry.PrimaryMood))
        {
            var moodInfo = Moods.All.GetValueOrDefault(entry.PrimaryMood);
            if (moodInfo != null)
            {
                moods.Add($"{moodInfo.Emoji} {moodInfo.Label}");
            }
        }
        
       
        var secondaryMoods = entry.SecondaryMoodsList;
        foreach (var secondaryMood in secondaryMoods)
        {
            if (!string.IsNullOrEmpty(secondaryMood))
            {
                var moodInfo = Moods.All.GetValueOrDefault(secondaryMood);
                if (moodInfo != null)
                {
                    moods.Add(moodInfo.Label);
                }
            }
        }
        
        return moods.Count > 0 ? string.Join(", ", moods) : "No mood selected";
    }

    private string FormatDateLong(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);
        
        if (date.Date == today)
            return $"Today, {date:MMMM dd, yyyy}";
        else if (date.Date == yesterday)
            return $"Yesterday, {date:MMMM dd, yyyy}";
        else
            return date.ToString("MMMM dd, yyyy");
    }

    private int GetWordCount(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return 0;
        
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        return plainText.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private string GetMonthYearDisplay()
    {
        return new DateTime(currentYear, currentMonth, 1).ToString("MMMM yyyy");
    }

    private async Task PreviousMonth()
    {
        currentMonth--;
        if (currentMonth < 1)
        {
            currentMonth = 12;
            currentYear--;
        }
        
        await LoadMonthEntries();
        selectedDate = null;
        selectedEntry = null;
    }

    private async Task NextMonth()
    {
        currentMonth++;
        if (currentMonth > 12)
        {
            currentMonth = 1;
            currentYear++;
        }
        
        await LoadMonthEntries();
        selectedDate = null;
        selectedEntry = null;
    }

    private async Task JumpToToday()
    {
        currentYear = DateTime.Now.Year;
        currentMonth = DateTime.Now.Month;
        
        await LoadMonthEntries();
        
        // Set selected date to today
        selectedDate = DateTime.Today;
        
        // Find today's date string in correct format
        var todayString = DateTime.Today.ToString("yyyy-MM-dd");
        
        // Load entry for today if it exists
        if (entriesByDate.ContainsKey(todayString))
        {
            selectedEntry = entriesByDate[todayString];
            
            // Load mood sticker for selected entry
            if (!string.IsNullOrEmpty(selectedEntry.PrimaryMood))
            {
                selectedMoodSticker = await MoodStickerService.GenerateMoodStickerSvgAsync(
                    selectedEntry.PrimaryMood, 100, 100
                );
            }
            
            
            selectedTags = await JournalService.GetTagsForEntryAsync(selectedEntry.Id);
            
            Console.WriteLine($"Found entry for today: {todayString}");
        }
        else
        {
            selectedEntry = null;
            selectedMoodSticker = null;
            selectedTags.Clear();
            Console.WriteLine($"‚ÑπNo entry for today: {todayString}");
        }
        
        // Update calendar dates to show selection
        GenerateCalendarDates();
        
        // Force UI update
        StateHasChanged();
    }

    private void EditEntry()
    {
        if (selectedDate.HasValue)
        {
            Navigation.NavigateTo($"/create-entry?date={selectedDate.Value:yyyy-MM-dd}");
        }
    }

    private void CreateNewEntry()
    {
        if (selectedDate.HasValue)
        {
            Navigation.NavigateTo($"/create-entry?date={selectedDate.Value:yyyy-MM-dd}");
        }
    }

    private async Task DeleteEntry()
    {
        if (selectedEntry != null)
        {
            try
            {
                var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");
                if (confirmed)
                {
                    await JournalService.DeleteEntryAsync(selectedEntry.Id);
                    await LoadMonthEntries();
                    selectedEntry = null;
                    selectedDate = null;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting entry: {ex.Message}");
            }
        }
    }
}
