@page "/settings"
@using MoodJournal.Models
@using MoodJournal.Services.Interfaces
@inject NavigationManager Navigation
@inject IDatabaseService DatabaseService

<div class="settings-container">
    
    <!-- HEADER -->
    <div class="settings-header">
        <button class="back-btn" @onclick='() => Navigation.NavigateTo("/main")'>
            ‚Üê Back
        </button>
        <h1 class="settings-title">Settings</h1>
    </div>

    <!-- CONTENT -->
    <div class="settings-content">
        
        <!-- PROFILE SECTION -->
        <div class="settings-card">
            <h2 class="card-title">üë§ Profile</h2>
            <div class="profile-info">
                
                <!-- Avatar Preview - FIXED CLASS NAME AND SIZE -->
                <div class="avatar-preview">
                    @if (avatarConfigId.HasValue)
                    {
                        <AvatarDisplay Size="180" AvatarConfigId="@avatarConfigId.Value" />
                    }
                    else
                    {
                        <div class="avatar-placeholder">üë§</div>
                    }
                </div>

                <!-- User Info -->
                <div class="user-info">
                    <div class="info-row">
                        <span class="label">Name:</span>
                        <span class="value">@userName</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Gender:</span>
                        <span class="value">@userGender</span>
                    </div>
                </div>

                <!-- Edit Button -->
                <button class="edit-btn" @onclick="EditAvatar">
                    ‚úèÔ∏è Edit Avatar
                </button>
            </div>
        </div>

        <!-- THEME CUSTOMIZATION (Feature 9) -->
        <div class="settings-card">
            <h2 class="card-title">üé® Theme Customization</h2>
            <div class="theme-section">
                <div class="theme-option">
                    <span class="theme-label">Theme Mode:</span>
                    <select class="theme-selector" @onchange="ChangeTheme">
                        <option value="light" selected="@(currentTheme == "light")">‚òÄÔ∏è Light</option>
                        <option value="dark" selected="@(currentTheme == "dark")">üåô Dark</option>
                        <option value="custom" selected="@(currentTheme == "custom")">üé® Custom</option>
                    </select>
                </div>
                
                @if (currentTheme == "custom")
                {
                    <div class="color-pickers">
                        <div class="color-option">
                            <span class="color-label">Accent Color:</span>
                            <input type="color" class="color-input" value="#f490af" @onchange="ChangeAccentColor" />
                        </div>
                        <div class="color-option">
                            <span class="color-label">Background Color:</span>
                            <input type="color" class="color-input" value="#fef5e8" @onchange="ChangeBackgroundColor" />
                        </div>
                    </div>
                }
                
                <div class="theme-preview">
                    <p class="preview-text">Theme preview will appear here</p>
                </div>
            </div>
        </div>

        <!-- EXPORT JOURNALS (Feature 12) -->
        <div class="settings-card">
            <h2 class="card-title">üìÑ Export Journals</h2>
            <div class="export-section">
                <p class="section-description">Export your journal entries as a PDF document</p>
                
                <div class="date-range">
                    <div class="date-input-group">
                        <label class="date-label">From:</label>
                        <input type="date" class="date-input" @bind="exportStartDate" />
                    </div>
                    <div class="date-input-group">
                        <label class="date-label">To:</label>
                        <input type="date" class="date-input" @bind="exportEndDate" />
                    </div>
                </div>
                
                <div class="export-options">
                    <label class="checkbox-option">
                        <input type="checkbox" @bind="includeMoods" />
                        <span>Include mood information</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" @bind="includeTags" />
                        <span>Include tags</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" @bind="includeImages" />
                        <span>Include images (if any)</span>
                    </label>
                </div>
                
                <button class="export-btn" @onclick="ExportJournals" disabled="@isExporting">
                    @if (isExporting)
                    {
                        <span>‚è≥ Exporting...</span>
                    }
                    else
                    {
                        <span>üì• Export as PDF</span>
                    }
                </button>
                
                @if (!string.IsNullOrEmpty(exportMessage))
                {
                    <div class="export-message @(exportSuccess ? "success" : "error")">
                        @exportMessage
                    </div>
                }
            </div>
        </div>

        <!-- SECURITY & PRIVACY (Feature 11) -->
        <div class="settings-card">
            <h2 class="card-title">üîí Security & Privacy</h2>
            <p class="coming-soon">Coming soon! (Feature 11)</p>
        </div>

    </div>

</div>

@code {
    private string userName = "User";
    private string userGender = "Unknown";
    private int? avatarConfigId = null;
    
    // Theme settings
    private string currentTheme = "light";
    
    // Export settings
    private DateTime exportStartDate = DateTime.Now.AddMonths(-1);
    private DateTime exportEndDate = DateTime.Now;
    private bool includeMoods = true;
    private bool includeTags = true;
    private bool includeImages = false;
    private bool isExporting = false;
    private string exportMessage = string.Empty;
    private bool exportSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserProfile();
        await LoadSettings();
    }

    private async Task LoadUserProfile()
    {
        try
        {
            var profile = await DatabaseService.GetUserProfileAsync();
            if (profile != null)
            {
                userName = profile.Name;
                avatarConfigId = profile.AvatarConfigId;

                var avatarConfig = await DatabaseService.GetUserAvatarAsync();
                if (avatarConfig != null)
                {
                    userGender = avatarConfig.Gender;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            var themeSetting = await DatabaseService.GetSettingAsync("Theme");
            if (!string.IsNullOrEmpty(themeSetting))
            {
                currentTheme = themeSetting;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading settings: {ex.Message}");
        }
    }

    private void EditAvatar()
    {
        Navigation.NavigateTo("/avatar");
    }

    private async Task ChangeTheme(ChangeEventArgs e)
    {
        currentTheme = e.Value?.ToString() ?? "light";
        try
        {
            await DatabaseService.SetSettingAsync("Theme", currentTheme);
            Console.WriteLine($"Theme changed to: {currentTheme}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving theme: {ex.Message}");
        }
    }

    private async Task ChangeAccentColor(ChangeEventArgs e)
    {
        var color = e.Value?.ToString() ?? "#f490af";
        try
        {
            await DatabaseService.SetSettingAsync("AccentColor", color);
            Console.WriteLine($"Accent color changed to: {color}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving accent color: {ex.Message}");
        }
    }

    private async Task ChangeBackgroundColor(ChangeEventArgs e)
    {
        var color = e.Value?.ToString() ?? "#fef5e8";
        try
        {
            await DatabaseService.SetSettingAsync("BackgroundColor", color);
            Console.WriteLine($"Background color changed to: {color}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving background color: {ex.Message}");
        }
    }

    private async Task ExportJournals()
    {
        isExporting = true;
        exportMessage = string.Empty;
        StateHasChanged();

        try
        {
            // TODO: Implement actual PDF export using IExportService
            // For now, simulate export
            await Task.Delay(2000);
            
            exportMessage = $"Successfully exported journals from {exportStartDate:MMM dd, yyyy} to {exportEndDate:MMM dd, yyyy}";
            exportSuccess = true;
            
            Console.WriteLine($"Exporting journals: {exportStartDate:yyyy-MM-dd} to {exportEndDate:yyyy-MM-dd}");
            Console.WriteLine($"Include moods: {includeMoods}, Include tags: {includeTags}, Include images: {includeImages}");
        }
        catch (Exception ex)
        {
            exportMessage = $"Export failed: {ex.Message}";
            exportSuccess = false;
            Console.WriteLine($"Error exporting: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }
}
